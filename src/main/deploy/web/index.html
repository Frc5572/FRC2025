<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral Selector</title>
    <style>
        #main {
            position: absolute;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
        }
        #side {
            position: absolute;
            right: 0;
            top: 0;
            height: 100vh;
            width: calc(30.7vw - 7px);
            background-color: #1e1e1e;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content: center; */
        }
        p {
            color: white;
        }
        .bad {
            background-color: #770000;
        }
    </style>
</head>
<body>
    <canvas id="main" width="1920" height="1080"></canvas>
    <div id="side">
        <p>Status: <span id="status" class="bad">Not Connected</span></p>
    </div>
    <img id="coral" src="coral.PNG" style="display: none;">
    <img id="coral2" src="coral2.PNG" style="display: none;">
    <script type="module">
        import { NT4_Client } from "./NT4.js"

        let status = document.getElementById("status");

        let client = new NT4_Client(
            window.location.hostname, 
            "coral-selector",
            (topic) => {
                // Topic announce
            }, 
            (topic) => {
                // Topic unannounce
            },
            (topic, timestamp, value) => {
                // Topic data
            },
            () => {
                // Connected
                status.classList.remove("bad");
                status.innerText = "Connected";
            },
            () => {
                // Disconnected
                status.classList.add("bad");
                status.innerText = "Not Connected";
            }
        );

        window.addEventListener("load", () => {
            // client.subscribe([], false, false, 0.02);
            client.publishTopic("/coral-selector/coralSide", "int");
            client.publishTopic("/coral-selector/coralHeightAndLR", "int");
            client.connect();
            redraw();
        })

        const canvas = document.getElementById("main");
        const ctx = canvas.getContext("2d");
        const coral = document.getElementById("coral");
        const coral2 = document.getElementById("coral2");

        let selected_right = 0;
        let selected_left = 0;

        function redraw() {
            console.log("redraw");
            // Draw Images
            ctx.drawImage(coral, 350, 60, 1120, 1120, 0, 0, 960, 1080);
            ctx.drawImage(coral2, 0, 0, 417, 1253, 960, 0, 370, 1080);

            // Draw Buttons
            ctx.lineWidth = 15;
            ctx.strokeStyle = "black";
            
            ctx.beginPath();
            ctx.moveTo(0, 1080 / 2);
            ctx.lineTo(960, 1080 / 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(220, 0);
            ctx.lineTo(740, 1080);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(740, 0);
            ctx.lineTo(220, 1080);
            ctx.stroke();

            ctx.strokeRect(0, 0, 960, 1080);

            const height = 1080 / 4;
            ctx.strokeStyle = "black";
            for(let i = 0; i < 4; i++) {
                ctx.strokeRect(960, height * i, 185, height);
                ctx.strokeRect(960+185, height * i, 185, height);
            }
            ctx.strokeStyle = "red";
            
            if(selected_left == 0) {
                ctx.beginPath();
                ctx.moveTo(0, 1080 / 2);
                ctx.lineTo(960 / 2, 1080 / 2);
                ctx.lineTo(220, 0);
                ctx.lineTo(0, 0);
                ctx.lineTo(0, 1080 / 2);
                ctx.stroke();
            } else if(selected_left == 1) {
                ctx.beginPath();
                ctx.moveTo(220, 0);
                ctx.lineTo(960 / 2, 1080 / 2);
                ctx.lineTo(740, 0);
                ctx.lineTo(220, 0);
                ctx.stroke();
            } else if(selected_left == 2) {
                ctx.beginPath();
                ctx.moveTo(960, 1080 / 2);
                ctx.lineTo(960 / 2, 1080 / 2);
                ctx.lineTo(740, 0);
                ctx.lineTo(960, 0);
                ctx.lineTo(960, 1080 / 2);
                ctx.stroke();
            } else if(selected_left == 3) {
                ctx.beginPath();
                ctx.moveTo(0, 1080 / 2);
                ctx.lineTo(960 / 2, 1080 / 2);
                ctx.lineTo(220, 1080);
                ctx.lineTo(0, 1080);
                ctx.lineTo(0, 1080 / 2);
                ctx.stroke();
            } else if(selected_left == 4) {
                ctx.beginPath();
                ctx.moveTo(220, 1080);
                ctx.lineTo(960 / 2, 1080 / 2);
                ctx.lineTo(740, 1080);
                ctx.lineTo(220, 1080);
                ctx.stroke();
            } else if(selected_left == 5) {
                ctx.beginPath();
                ctx.moveTo(960, 1080 / 2);
                ctx.lineTo(960 / 2, 1080 / 2);
                ctx.lineTo(740, 1080);
                ctx.lineTo(960, 1080);
                ctx.lineTo(960, 1080 / 2);
                ctx.stroke();
            }

            for(let i = 0; i < 4; i++) {
                if(selected_right == i*2) {
                    ctx.strokeRect(960, height * i, 185, height);
                }
                if(selected_right == i*2 + 1) {
                    ctx.strokeRect(960+185, height * i, 185, height);
                }
            }

            ctx.fillStyle = "white";
            ctx.font = "50px serif";
            ctx.fillText("DRIVER SIDE", 960/2-150, 1080-20);
            ctx.fillText("BARGE SIDE", 960/2-150, 50);
        }

        coral.addEventListener("load", (e) => {
            redraw();
        });

        coral2.addEventListener("load", (e) => {
            redraw();
        });

        canvas.addEventListener("click", (e) => {
            let x = e.offsetX / canvas.clientWidth * 1920;
            let y = e.offsetY / canvas.clientHeight * 1080;
            
            if(x < 960) {
                // Left selector
                let l1 = y > (-2.077 * x + 1536.94);
                let l2 = y > (2.077 * x - 456.98);
                let l3 = y > 1080 / 2;
                if(!l1 && l2 && !l3) {
                    selected_left = 0;
                } else if(!l1 && !l2 && !l3) {
                    selected_left = 1;
                } else if(l1 && !l2 && !l3) {
                    selected_left = 2;
                } else if(!l1 && l2 && l3) {
                    selected_left = 3;
                } else if(l1 && l2 && l3) {
                    selected_left = 4;
                } else if(l1 && !l2 && l3) {
                    selected_left = 5;
                }
                redraw();
            } else if (x < 960 + 370 / 2) {
                // Right selector left column
                const height = 1080 / 4;
                for(let i = 0; i < 4; i++) {
                    if (y > i * height && y < (i + 1) * height) {
                        selected_right = 2 * i;
                        redraw();
                        break;
                    }
                }
            } else if (x < 960 + 370) {
                // Right selector right column
                const height = 1080 / 4;
                for(let i = 0; i < 4; i++) {
                    if (y > i * height && y < (i + 1) * height) {
                        selected_right = 2 * i + 1;
                        redraw();
                        break;
                    }
                }
            }
        })
    </script>
</body>
</html>